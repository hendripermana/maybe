<%# locals: (sankey_data:, period:) %>
<div id="cashflow-sankey-chart" class="chart-container dashboard-section">
  <!-- Regular container -->
  <div data-cashflow-fullscreen-target="regularContainer" class="w-full regular-chart-container">
    <% if sankey_data[:links].present? %>
      <div class="relative w-full h-full">
        <!-- Loading overlay (initially hidden) -->
        <div id="sankey-loading" class="absolute inset-0 flex items-center justify-center bg-background/80 backdrop-blur-sm rounded-lg z-10" style="display: none;">
          <div class="flex flex-col items-center space-y-3">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
            <p class="text-sm text-muted-foreground">Loading cash flow analysis...</p>
          </div>
        </div>
        
        <div
          data-controller="sankey-chart"
          data-sankey-chart-data-value="<%= sankey_data.to_json %>"
          data-sankey-chart-currency-symbol-value="<%= sankey_data[:currency_symbol] %>"
          data-cashflow-fullscreen-target="chartContainer"
          class="w-full h-full sankey-svg-container chart-transition"
          style="height: 540px;">
        </div>
      </div>
    <% else %>
      <div class="h-full flex flex-col items-center justify-center" style="height: 540px;">
        <div class="space-y-4 text-center flex flex-col items-center">
          <%= icon "activity", size: "lg", class: "text-muted-foreground" %>

          <div>
            <p class="text-sm font-medium text-foreground">No cash flow data for this time period</p>
            <p class="text-muted-foreground text-sm">Add transactions to display cash flow data or expand the time period</p>
          </div>
          
          <%= render Ui::ButtonComponent.new(
            text: "Add transaction",
            icon: "plus",
            href: new_transaction_path,
            variant: :default,
            size: :sm
          ) %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Fullscreen overlay -->
  <div 
    data-cashflow-fullscreen-target="fullscreenOverlay"
    class="fullscreen-overlay hidden">
    
    <div data-cashflow-fullscreen-target="fullscreenContainer" class="fullscreen-container bg-background">
      <!-- Fullscreen header -->
      <div class="flex items-center justify-between p-6 border-b border-border bg-card">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
            <%= icon "activity", size: "sm", class: "text-white" %>
          </div>
          <h2 class="text-xl font-semibold text-foreground">Cash Flow Analysis</h2>
        </div>
        <div class="flex items-center gap-3">
          <%= form_with url: root_path, method: :get, data: { controller: "auto-submit-form", turbo_frame: "cashflow_sankey_section" }, html: { class: "m-0" }, local: true do |form| %>
            <% period_options = Period.as_options + [["ALL", "all"]] %>
            <%= form.select :cashflow_period,
                      period_options,
                      { selected: (params[:cashflow_period] || period.key) },
                      data: { "auto-submit-form-target": "auto" },
                      class: "input-modern text-sm min-w-[120px]" %>
          <% end %>
          <!-- Close button -->
          <button 
            data-action="click->cashflow-fullscreen#toggleFullscreen"
            class="btn-modern-ghost h-9 w-9 p-0 flex items-center justify-center rounded-md border border-border hover:bg-accent transition-colors"
            title="Exit fullscreen">
            <%= icon "x", size: "sm", class: "text-foreground" %>
          </button>
        </div>
      </div>

      <!-- Fullscreen chart container -->
      <div class="fullscreen-chart-container">
        <% if sankey_data[:links].present? %>
          <div class="w-full h-full bg-card rounded-xl border border-border shadow-sm p-6">
            <div
              data-controller="sankey-chart"
              data-sankey-chart-data-value="<%= sankey_data.to_json %>"
              data-sankey-chart-currency-symbol-value="<%= sankey_data[:currency_symbol] %>"
              class="w-full h-full sankey-svg-container chart-transition"
              style="min-height: 600px;">
            </div>
          </div>
        <% else %>
          <div class="h-full bg-card rounded-xl border border-border shadow-sm py-8 flex flex-col items-center justify-center">
            <div class="space-y-4 text-center flex flex-col items-center">
              <%= icon "activity", size: "lg", class: "text-muted-foreground" %>

              <div class="space-y-2">
                <p class="text-lg font-semibold text-foreground">No cash flow data for this time period</p>
                <p class="text-muted-foreground">Add transactions to display cash flow data or expand the time period</p>
              </div>
              <%= render Ui::ButtonComponent.new(
                text: "Add transaction",
                icon: "plus",
                href: new_transaction_path,
                variant: :default,
                size: :sm
              ) %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
