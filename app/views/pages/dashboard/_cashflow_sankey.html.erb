<%# locals: (sankey_data:, period:) %>
<div id="cashflow-sankey-chart" data-controller="cashflow-fullscreen" class="chart-container">
  <div class="flex justify-between items-center gap-4 mb-6">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-elevated">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
      </div>
      <div>
        <h2 class="text-lg font-semibold text-primary">Cash Flow</h2>
        <p class="text-sm text-secondary">Visualizing your money movement</p>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <%= form_with url: root_path, method: :get, data: { controller: "auto-submit-form", turbo_frame: "cashflow_sankey_section" } do |form| %>
        <% period_options = Period.as_options + [["ALL", "all"]] %>
        <%= form.select :cashflow_period,
                  period_options,
                  { selected: period.key },
                  data: { "auto-submit-form-target": "auto" },
                  class: "input-modern text-sm min-w-[120px]" %>
      <% end %>

      <!-- Fullscreen toggle button -->
      <button 
        data-cashflow-fullscreen-target="toggleButton"
        data-action="click->cashflow-fullscreen#toggleFullscreen"
        class="btn-modern-ghost h-9 w-9 !p-0 flex items-center justify-center"
        title="Toggle fullscreen">
        <!-- Expand icon -->
        <svg data-cashflow-fullscreen-target="expandIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
        </svg>
        <!-- Collapse icon (initially hidden) -->
        <svg data-cashflow-fullscreen-target="collapseIcon" class="w-4 h-4 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Regular container -->
  <div data-cashflow-fullscreen-target="regularContainer" class="w-full">
    <% if sankey_data[:links].present? %>
      <div class="w-full h-[500px] lg:h-[600px] rounded-lg border border-gray-700/50 dark:border-gray-600/50 bg-surface-inset/30 dark:bg-gray-800/30 p-4">
        <div
          data-controller="sankey-chart"
          data-sankey-chart-data-value="<%= sankey_data.to_json %>"
          data-sankey-chart-currency-symbol-value="<%= sankey_data[:currency_symbol] %>"
          data-cashflow-fullscreen-target="chartContainer"
          class="w-full h-full rounded-md hover:bg-surface-hover/20 dark:hover:bg-gray-700/20 transition-colors duration-300"></div>
      </div>
    <% else %>
      <div class="h-[300px] lg:h-[340px] bg-container dark:bg-[#1a1a1a] py-4 flex flex-col items-center justify-center">
        <div class="space-y-3 text-center flex flex-col items-center">
          <%= render FilledIconComponent.new(
            variant: :container,
            icon: "activity" # cashflow placeholder icon
          ) %>

          <p class="text-sm font-medium text-primary">No cash flow data for this time period</p>
          <p class="text-secondary text-sm">Add transactions to display cash flow data or expand the time period</p>
          <%= render LinkComponent.new(
            text: "Add transaction",
            icon: "plus",
            href: new_transaction_path,
            frame: :modal
          ) %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Fullscreen overlay -->
  <div 
    data-cashflow-fullscreen-target="fullscreenOverlay"
    class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm hidden">
    
    <div data-cashflow-fullscreen-target="fullscreenContainer" class="modal-modern w-full h-full !rounded-none flex flex-col">
      <!-- Fullscreen header -->
      <div class="flex items-center justify-between p-6 border-b border-secondary/50 dark:border-gray-600/50">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
          </div>
          <h2 class="text-xl font-semibold text-primary">Cash Flow Analysis</h2>
        </div>
        <div class="flex items-center gap-3">
          <%= form_with url: root_path, method: :get, data: { controller: "auto-submit-form", turbo_frame: "cashflow_sankey_section" }, html: { class: "m-0" }, local: true do |form| %>
            <% period_options = Period.as_options + [["ALL", "all"]] %>
            <%= form.select :cashflow_period,
                      period_options,
                      { selected: (params[:cashflow_period] || period.key) },
                      data: { "auto-submit-form-target": "auto" },
                      class: "input-modern text-sm min-w-[120px]" %>
          <% end %>
          <!-- Close button -->
          <button 
            data-action="click->cashflow-fullscreen#toggleFullscreen"
            class="btn-modern-ghost h-9 w-9 !p-0 flex items-center justify-center"
            title="Exit fullscreen">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>

      <!-- Fullscreen chart container -->
      <div class="flex-1 p-6 bg-gradient-to-br from-container to-container-hover dark:from-[#1a1a1a] dark:to-gray-800">
        <% if sankey_data[:links].present? %>
          <div class="w-full h-full bg-container dark:bg-[#1a1a1a] rounded-xl border border-gray-700/50 dark:border-gray-600/50 shadow-elevated p-4">
            <div
              data-controller="sankey-chart"
              data-sankey-chart-data-value="<%= sankey_data.to_json %>"
              data-sankey-chart-currency-symbol-value="<%= sankey_data[:currency_symbol] %>"
              class="w-full h-full"></div>
          </div>
        <% else %>
          <div class="h-full bg-container dark:bg-[#1a1a1a] rounded-xl border border-gray-700/50 dark:border-gray-600/50 shadow-elevated py-8 flex flex-col items-center justify-center">
            <div class="space-y-4 text-center flex flex-col items-center">
              <%= render FilledIconComponent.new(
                variant: :container,
                icon: "activity"
              ) %>

              <div class="space-y-2">
                <p class="text-lg font-semibold text-primary">No cash flow data for this time period</p>
                <p class="text-secondary">Add transactions to display cash flow data or expand the time period</p>
              </div>
              <%= render LinkComponent.new(
                text: "Add transaction",
                icon: "plus",
                href: new_transaction_path,
                frame: :modal,
                class: "btn-modern-primary"
              ) %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
