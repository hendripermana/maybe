<%# Navigation items are now managed by the NavigationComponent %>
<% expanded_sidebar_class = "w-full" %>
<% collapsed_sidebar_class = "w-0" %>

<%= render "layouts/shared/htmldoc" do %>
  <div
    class="flex flex-col lg:flex-row h-full bg-surface"
    data-controller="app-layout"
    data-app-layout-expanded-sidebar-class="<%= expanded_sidebar_class %>"
    data-app-layout-collapsed-sidebar-class="<%= collapsed_sidebar_class %>"
    data-app-layout-user-id-value="<%= Current.user.id %>">
    <div
      class="hidden fixed inset-0 bg-surface z-20 h-full w-full pt-[calc(env(safe-area-inset-top)+0.75rem)] pr-3 pb-[calc(env(safe-area-inset-bottom)+0.75rem)] pl-3 overflow-y-auto transition-all duration-300"
      data-app-layout-target="mobileSidebar">
      <div class="mb-2">
        <%= icon("x", as_button: true, data: { action: "app-layout#closeMobileSidebar" }) %>
      </div>

      <%= render(
        "accounts/account_sidebar_tabs",
        family: Current.family,
        active_tab: @account_group_tab,
        mobile: true
      ) %>
    </div>

    <%# MOBILE - Top nav %>
    <%= render Ui::NavigationComponent.new(current_path: request.path, variant: :mobile) %>

    <%# DESKTOP - Left navbar %>
    <div class="hidden lg:block">
      <%= render Ui::NavigationComponent.new(current_path: request.path, variant: :desktop) %>
    </div>

    <%# DESKTOP - Left sidebar %>
    <%= tag.div class: class_names(
        "hidden lg:block py-4 overflow-y-auto shrink-0 max-w-[320px] transition-all duration-300",
        Current.user.show_sidebar? ? expanded_sidebar_class : collapsed_sidebar_class,
       ),
       data: { app_layout_target: "leftSidebar" } do %>
      <% if content_for?(:sidebar) %>
        <%= yield :sidebar %>
      <% else %>
        <div class="h-full flex flex-col">
          <div class="overflow-y-auto grow">
            <%= render "accounts/account_sidebar_tabs", family: Current.family, active_tab: @account_group_tab %>
          </div>

          <% if Current.family.trialing? && !self_hosted? %>
            <div class="px-4 py-3 space-y-4 bg-container shadow-border-xs rounded-xl">
              <div class="flex items-start justify-between">
                <div>
                  <p class="text-sm font-medium text-primary">Free trial</p>
                  <p class="text-sm text-secondary"><%= Current.family.days_left_in_trial %> days remaining</p>
                </div>

                <%= render LinkComponent.new(
                  text: "Upgrade",
                  href: upgrade_subscription_path,
                ) %>
              </div>

              <div class="flex items-center gap-0.5 h-1.5">
                <div class="h-full bg-warning rounded-full" style="width: <%= Current.family.percentage_of_trial_completed %>%"></div>
                <div class="h-full bg-surface-inset rounded-full" style="width: <%= Current.family.percentage_of_trial_remaining %>%"></div>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    <% end %>

    <%# SHARED - Main content %>
    <%= tag.main id: "main-content", class: class_names("grow overflow-y-auto px-4 lg:px-12 w-full mx-auto max-w-7xl"), data: { app_layout_target: "content" } do %>
      <div class="hidden lg:flex gap-3 items-center justify-between mb-8 pt-6">
        <div class="flex items-center gap-3">
          <%= icon("panel-left", as_button: true, data: { action: "app-layout#toggleLeftSidebar" }, class: "btn-modern-ghost w-9 h-9 !p-0") %>

          <% if content_for?(:breadcrumbs) %>
            <%= yield :breadcrumbs %>
          <% else %>
            <%= render Ui::BreadcrumbsComponent.new(breadcrumbs: @breadcrumbs) %>
          <% end %>
        </div>
        <%= icon("panel-right", as_button: true, data: { action: "app-layout#toggleRightSidebar" }, class: "btn-modern-ghost w-9 h-9 !p-0") %>
      </div>

      <% if content_for?(:page_header) %>
        <%= yield :page_header %>
      <% end %>

      <div class="<%= 'dashboard-main-content' if controller_name == 'pages' && action_name == 'dashboard' %>">
        <%= yield %>
        <%= render PerformanceMetricsComponent.new(show_in_ui: Rails.env.development? && params[:show_metrics]) %>
      </div>
      
      <%= render FeedbackFormComponent.new(
        position: :bottom_right,
        current_page: request.path,
        current_user: Current.user
      ) %>
    <% end %>

    <%# DESKTOP - Right sidebar %>
    <%= tag.div class: class_names(
          "hidden lg:block h-full overflow-y-auto shrink-0 max-w-[400px] transition-all duration-300",
          Current.user.show_ai_sidebar? ? expanded_sidebar_class : collapsed_sidebar_class,
        ),
        data: { app_layout_target: "rightSidebar" } do %>
      <%= tag.div id: "chat-container", class: "relative h-full", data: { controller: "chat hotkey", turbo_permanent: true } do %>
        <div class="flex flex-col h-full justify-between shrink-0">
          <%= turbo_frame_tag chat_frame, src: chat_view_path(@chat), loading: "lazy", class: "h-full" do %>
            <div class="flex justify-center items-center h-full">
              <%= icon("loader-circle", class: "animate-spin") %>
            </div>
          <% end %>
        </div>

        <% unless Current.user.ai_enabled? %>
          <div class="absolute backdrop-blur-lg inset-0 h-full w-full flex flex-col justify-center items-center pl-0.5 pr-4">
            <%= render "chats/ai_consent" %>
          </div>
        <% end %>
      <% end %>
    <% end %>

    <%# MOBILE - Bottom Nav is now part of the NavigationComponent :mobile variant %>
  </div>
<% end %>